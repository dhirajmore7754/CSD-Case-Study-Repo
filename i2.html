    
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Birthday VFX Video</title>
  <style>
    :root{
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.18);
      --txt: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.70);
    }
    html,body{height:100%; margin:0; background:#070611; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    #app{position:fixed; inset:0; overflow:hidden;}
    canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

    .hud{position:absolute; inset:0; padding:16px; display:flex; flex-direction:column; justify-content:space-between; pointer-events:none;}
    .topbar{display:flex; justify-content:space-between; gap:12px; align-items:center;}
    .pill{
      pointer-events:auto; display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:999px;
      background:linear-gradient(180deg,var(--glass2),var(--glass));
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 28px rgba(0,0,0,.30);
      color:var(--txt);
    }
    .dot{width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ff79c9);
      box-shadow: 0 0 20px rgba(255,121,201,.55);
    }
    .badge{font-size:12px; color:var(--muted);}
    .controls{pointer-events:auto; display:flex; gap:10px; flex-wrap:wrap;}
    button{
      cursor:pointer; border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color:var(--txt);
      padding:10px 14px; border-radius:16px; font-weight:800;
      backdrop-filter: blur(10px);
      transition: transform .15s ease, border-color .15s ease;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32);}
    button:active{transform: translateY(0) scale(.99);}

    .bottombar{display:flex; justify-content:space-between; gap:12px; align-items:flex-end;}
    .hint{
      max-width:min(640px, 92vw);
      padding:12px 14px; border-radius:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.12));
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      color:var(--txt);
    }
    .hint .title{font-size:12px; color:var(--muted); margin-bottom:4px;}
    .hint .line{font-size:14px; line-height:1.35;}

    .sceneLabel{
      position:absolute; left:16px; bottom:92px;
      padding:8px 12px; border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.82);
      backdrop-filter: blur(8px);
      font-size:12px; pointer-events:none;
    }
    .sticker{
      position:absolute; right:18px; bottom:98px;
      font-size:22px; opacity:.95;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
      animation: bob 2.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes bob{0%,100%{transform: translateY(0) rotate(-6deg);} 50%{transform: translateY(-6px) rotate(6deg);}}

    .popup{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%) scale(.92);
      opacity:0;
      padding:18px 18px 20px;
      border-radius:26px;
      text-align:center;
      background:
        radial-gradient(900px 420px at 50% 0%, rgba(255,121,201,.30), transparent 60%),
        radial-gradient(800px 420px at 50% 100%, rgba(134,215,255,.22), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:2px solid rgba(255,255,255,.22);
      backdrop-filter: blur(12px);
      box-shadow: 0 25px 90px rgba(0,0,0,.60);
      pointer-events:none;
      min-width:min(680px, 92vw);
      color:var(--txt);
    }
    .popup:after{
      content:"";
      position:absolute; left:50%; bottom:-16px;
      width:34px; height:34px;
      transform: translateX(-50%) rotate(45deg);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border-right:2px solid rgba(255,255,255,.18);
      border-bottom:2px solid rgba(255,255,255,.18);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
    }
    .popup h1{margin:0; font-size: clamp(26px, 4.4vw, 48px); text-shadow: 0 0 30px rgba(255,121,201,.28), 0 0 40px rgba(134,215,255,.18);}
    .popup p{margin:8px 0 0; color:rgba(255,255,255,.78); font-size: clamp(13px, 2.4vw, 16px); line-height:1.35;}
    .shine{
      background: linear-gradient(90deg, #ffe29a, #fff, #ff79c9);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 0 16px rgba(255,226,154,.22));
    }
    .popup.show{opacity:1; transform: translate(-50%,-50%) scale(1); transition: opacity .55s ease, transform .55s cubic-bezier(.18,.9,.26,1.2);}
    .popup.hide{opacity:0; transform: translate(-50%,-50%) scale(.96); transition: opacity .45s ease, transform .45s ease;}
  </style>
</head>
<body>
<div id="app">
  <canvas id="vfx"></canvas>

  <div class="hud">
    <div class="topbar">
      <div class="pill">
        <span class="dot"></span>
        <div>
          <div style="font-weight:900; line-height:1.05;">Birthday VFX (Long + Fast)</div>
          <div class="badge" id="status">Click ‚ÄúStart‚Äù</div>
        </div>
      </div>
      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="speedBtn">Speed: 1.25√ó</button>
        <button id="replayBtn">Replay</button>
      </div>
    </div>

    <div class="bottombar">
      <div class="hint">
        <div class="title">Now playing</div>
        <div class="line" id="hintLine">Garden scene with birds, butterflies, petals, clouds‚Ä¶</div>
      </div>
      <div class="pill">
        <div style="font-size:12px; color:rgba(255,255,255,.6)">Name:</div>
        <div style="font-weight:900" id="nameTag">Muskan</div>
      </div>
    </div>
  </div>

  <div class="popup" id="popup">
    <h1>Happy Birthday <span class="shine" id="nameBig">Muskan</span> üéÄ‚ú®</h1>
    <p>May your days be peaceful like nature, and your smile be anime-cute forever üå∏</p>
  </div>

  <div class="sceneLabel" id="sceneLabel">Scene / Garden</div>
  <div class="sticker" id="cornerSticker">üå∏</div>
</div>

<script>
(() => {
  // ============================
  // EDIT THESE
  // ============================
  const BIRTHDAY_NAME = "Muskan";
  const SPEED_PRESETS = [1.25, 1.4, 1.6];  // tap Speed button to switch
  // ============================

  const canvas = document.getElementById("vfx");
  const ctx = canvas.getContext("2d");
  const status = document.getElementById("status");
  const hintLine = document.getElementById("hintLine");
  const sceneLabel = document.getElementById("sceneLabel");
  const cornerSticker = document.getElementById("cornerSticker");
  const popup = document.getElementById("popup");

  document.getElementById("nameTag").textContent = BIRTHDAY_NAME;
  document.getElementById("nameBig").textContent = BIRTHDAY_NAME;

  // HiDPI
  let W=innerWidth, H=innerHeight, dpr=Math.min(devicePixelRatio||1, 2);
  function resize(){
    W=innerWidth; H=innerHeight; dpr=Math.min(devicePixelRatio||1, 2);
    canvas.width = Math.floor(W*dpr);
    canvas.height = Math.floor(H*dpr);
    canvas.style.width = W+"px";
    canvas.style.height = H+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize);
  resize();

  // Helpers
  const clamp01 = x => Math.max(0, Math.min(1,x));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const rand = (a,b)=>a+Math.random()*(b-a);

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function softGlowCircle(x,y,r,c,blur=20,a=0.35){
    ctx.save();
    ctx.globalAlpha = a;
    ctx.fillStyle = c;
    ctx.shadowColor = c;
    ctx.shadowBlur = blur;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function vignette(str=0.35){
    const g = ctx.createRadialGradient(W/2, H/2, Math.min(W,H)*0.2, W/2, H/2, Math.max(W,H)*0.75);
    g.addColorStop(0, "rgba(0,0,0,0)");
    g.addColorStop(1, `rgba(0,0,0,${str})`);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);
  }

  // ============================
  // Timeline (long video)
  // Total ~ 86s, loops
  // ============================
  const timeline = [
    { name:"Garden",  dur:28, sticker:"üåø", hint:"Garden + girl on chair + birds + butterflies + petals + popup", draw:drawGarden },
    { name:"Gift",    dur:18, sticker:"üéÅ", hint:"Gift opens + heart confetti + birds pass by", draw:drawGiftScene },
    { name:"SkyShow", dur:22, sticker:"‚≠ê", hint:"Fireworks + star glow + more birds", draw:drawFireworksScene },
    { name:"WishCard",dur:18, sticker:"üéÄ", hint:"Big wish card + floating stickers + soft nature ambience", draw:drawCardScene },
  ];
  const fadeDur = 1.2;

  function totalDuration(){
    return timeline.reduce((s,x)=>s+x.dur, 0);
  }

  function sceneAtTime(t){
    const T = totalDuration();
    let tt = ((t % T) + T) % T;
    let acc = 0;
    for(let i=0;i<timeline.length;i++){
      const seg = timeline[i];
      if(tt < acc + seg.dur){
        return { i, local: tt-acc, seg };
      }
      acc += seg.dur;
    }
    return { i:0, local:0, seg:timeline[0] };
  }

  function fadeAlpha(local, dur){
    const inA  = clamp01(local / fadeDur);
    const outA = clamp01((dur - local) / fadeDur);
    return Math.min(inA, outA);
  }

  function showPopup(){ popup.classList.remove("hide"); popup.classList.add("show"); }
  function hidePopup(){ popup.classList.remove("show"); popup.classList.add("hide"); }

  // ============================
  // Nature objects
  // ============================
  // Clouds (parallax)
  const cloudsBack = Array.from({length: 6}, () => ({
    x: rand(-300, W+300), y: rand(H*0.06, H*0.22), s: rand(0.9, 1.7), v: rand(10, 18)
  }));
  const cloudsFront = Array.from({length: 4}, () => ({
    x: rand(-300, W+300), y: rand(H*0.10, H*0.28), s: rand(1.2, 2.2), v: rand(18, 28)
  }));

  // Birds (parallax + flapping)
  const birds = Array.from({length: 14}, () => makeBird(true));
  function makeBird(high){
    const depth = high ? rand(0.25,0.55) : rand(0.55,0.9);
    return {
      x: rand(-200, W+200),
      y: rand(H*(high?0.08:0.18), H*(high?0.32:0.55)),
      vx: rand(40, 120) * (Math.random()<0.5 ? 1 : -1),
      depth,
      wing: rand(0, Math.PI*2),
      size: rand(10, 22) * (1.2 - depth),
      col: depth < 0.6 ? "rgba(15,15,20,.72)" : "rgba(25,25,32,.58)"
    };
  }

  // Butterflies (near girl)
  const butterflies = Array.from({length: 10}, () => ({
    x: rand(W*0.18, W*0.55),
    y: rand(H*0.32, H*0.62),
    vx: rand(-22, 22),
    vy: rand(-16, 16),
    ph: rand(0, Math.PI*2),
    s: rand(8, 16),
  }));

  // Petals (sakura)
  const petals = Array.from({length: 1100}, () => ({
    x: rand(-200, W+200),
    y: rand(-H, H),
    vx: rand(-14, 14),
    vy: rand(18, 48),
    r: rand(0, Math.PI*2),
    vr: rand(-2.0, 2.0),
    s: rand(4, 9),
    a: rand(0.16, 0.42),
  }));

  // Leaves (more realistic movement)
  const leaves = Array.from({length: 180}, () => ({
    x: rand(-200, W+200),
    y: rand(-H*0.2, H),
    vx: rand(10, 30),
    vy: rand(25, 55),
    r: rand(0, Math.PI*2),
    vr: rand(-3.0, 3.0),
    s: rand(6, 14),
    col: ["rgba(140,255,200,.35)","rgba(255,226,154,.25)","rgba(255,121,201,.18)"][ (Math.random()*3)|0 ],
  }));

  // Confetti (scene gift)
  let confetti = [];
  function burstConfetti(){
    confetti = Array.from({length: 520}, () => ({
      x: W*0.66 + rand(-60,60),
      y: H*0.64 + rand(-50,50),
      vx: rand(-260,260),
      vy: rand(-560,-160),
      g: rand(560, 900),
      r: rand(0, Math.PI*2),
      vr: rand(-10,10),
      s: rand(6, 16),
      life: rand(1.9, 2.8),
      kind: Math.random()<0.72 ? "heart" : "star",
      col: ["#ff79c9","#86d7ff","#ffe29a","#8bffc8","#ffffff"][(Math.random()*5)|0]
    }));
  }

  // Fireworks (scene skyshow)
  let fireworks = [];
  function spawnFirework(){
    const x = rand(W*0.22, W*0.78);
    const y = rand(H*0.12, H*0.42);
    const col = ["#ff79c9","#86d7ff","#ffe29a","#8bffc8","#ffffff"][(Math.random()*5)|0];
    const parts = Array.from({length: 140}, () => {
      const a = rand(0, Math.PI*2);
      const sp = rand(90, 320);
      return {x, y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp, life: rand(1.2, 1.9)};
    });
    fireworks.push({col, parts});
  }

  // Card stickers (scene 4)
  const cardStickers = Array.from({length: 18}, () => ({
    x: rand(W*0.18, W*0.82),
    y: rand(H*0.18, H*0.72),
    s: rand(16, 34),
    ph: rand(0, Math.PI*2),
    emoji: ["üíñ","üåü","üßÅ","üéÄ","üå∑","‚ú®","üçì","ü´∂","üê¶","üå∏"][(Math.random()*10)|0]
  }));

  // ============================
  // Drawing primitives
  // ============================
  function drawSky(dayMood=0.0){
    // dayMood: 0 normal, 1 more night
    const g = ctx.createLinearGradient(0,0,0,H);
    const top  = dayMood<0.5 ? "#86d7ff" : "#4a60b8";
    const mid  = dayMood<0.5 ? "#b7a7ff" : "#7a74d8";
    const bot  = "#070611";
    g.addColorStop(0, top);
    g.addColorStop(0.45, mid);
    g.addColorStop(1, bot);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // sun / moon glow
    const sunX = W*0.14 + Math.sin(globalT*0.03)*W*0.05;
    const sunY = H*0.14 + Math.cos(globalT*0.02)*H*0.03;
    softGlowCircle(sunX, sunY, 56, dayMood<0.5 ? "rgba(255,226,154,.95)" : "rgba(180,200,255,.85)", 30, 0.28);
    softGlowCircle(sunX+90, sunY+20, 20, "rgba(255,121,201,.85)", 24, 0.14);
    softGlowCircle(sunX+140, sunY+60, 12, "rgba(134,215,255,.85)", 18, 0.12);
  }

  function drawCloud(x,y,s,alpha=0.92){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(s,s);
    ctx.globalAlpha = alpha;
    ctx.filter = "blur(0.7px)";
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.beginPath();
    ctx.ellipse(0, 0, 78, 48, 0, 0, Math.PI*2);
    ctx.ellipse(68, -16, 64, 42, 0, 0, Math.PI*2);
    ctx.ellipse(-68, -12, 58, 40, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.filter = "none";
    ctx.restore();
  }

  function drawHills(dayMood=0.0){
    ctx.save();
    ctx.globalAlpha = 0.92;

    // far hills
    let g = ctx.createLinearGradient(0,H*0.45,0,H);
    g.addColorStop(0, dayMood<0.5 ? "rgba(30,40,80,.32)" : "rgba(20,25,60,.40)");
    g.addColorStop(1, "rgba(0,0,0,.20)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.moveTo(0, H*0.62);
    ctx.quadraticCurveTo(W*0.22, H*0.55, W*0.5, H*0.62);
    ctx.quadraticCurveTo(W*0.78, H*0.70, W, H*0.62);
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
    ctx.fill();

    // near hills
    g = ctx.createLinearGradient(0,H*0.55,0,H);
    g.addColorStop(0, "rgba(0,0,0,.18)");
    g.addColorStop(1, "rgba(0,0,0,.34)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.moveTo(0, H*0.70);
    ctx.quadraticCurveTo(W*0.35, H*0.63, W*0.62, H*0.72);
    ctx.quadraticCurveTo(W*0.82, H*0.80, W, H*0.74);
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
    ctx.fill();

    ctx.restore();
  }

  function drawGround(){
    const g = ctx.createLinearGradient(0,H*0.62,0,H);
    g.addColorStop(0, "rgba(139,255,200,.86)");
    g.addColorStop(1, "rgba(25,120,85,.70)");
    ctx.fillStyle = g;
    ctx.fillRect(0, H*0.62, W, H*0.38);

    // tiny grass sparkles
    ctx.globalAlpha = 0.10;
    ctx.fillStyle = "#ffffff";
    for(let i=0;i<900;i++){
      const x = (i*47)%W;
      const y = H*0.62 + ((i*97)%(H*0.38));
      ctx.fillRect(x, y, 1, 1);
    }
    ctx.globalAlpha = 1;

    // flowers
    for(let i=0;i<42;i++){
      const x = (i*211)%W;
      const y = H*0.70 + ((i*173)%(H*0.26));
      const s = 2 + ((i*13)%4);
      ctx.save();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = i%3===0 ? "#ff79c9" : (i%3===1 ? "#ffe29a" : "#86d7ff");
      ctx.beginPath();
      ctx.arc(x,y,s,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  function drawSakuraTree(x,y,scale=1,wind=0){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);

    // trunk with gradient (more realistic)
    const tg = ctx.createLinearGradient(-10,0,10,140);
    tg.addColorStop(0, "rgba(80,45,55,.95)");
    tg.addColorStop(1, "rgba(40,22,30,.95)");
    ctx.strokeStyle = tg;
    ctx.lineWidth = 12;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(0, 140);
    ctx.quadraticCurveTo(-12 + wind*3, 90, -6 + wind*2, 35);
    ctx.stroke();

    // branches
    ctx.lineWidth = 7;
    ctx.beginPath();
    ctx.moveTo(-6, 55);
    ctx.quadraticCurveTo(-35 + wind*4, 35, -52 + wind*4, 12);
    ctx.moveTo(-6, 48);
    ctx.quadraticCurveTo(10 + wind*4, 30, 32 + wind*4, 10);
    ctx.stroke();

    // canopy blobs + highlight
    const blobs = [
      {x:-70,y:18,r:56},{x:0,y:-2,r:66},{x:74,y:20,r:52},
      {x:-28,y:-42,r:46},{x:34,y:-48,r:44}
    ];

    // glow layer
    ctx.globalAlpha = 0.30;
    ctx.fillStyle = "#ff79c9";
    ctx.filter = "blur(12px)";
    blobs.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x + wind*8, b.y, b.r, 0, Math.PI*2); ctx.fill(); });
    ctx.filter = "none"; ctx.globalAlpha = 1;

    // main canopy gradient
    blobs.forEach(b=>{
      const cg = ctx.createRadialGradient(b.x-18, b.y-18, 10, b.x, b.y, b.r);
      cg.addColorStop(0, "rgba(255,255,255,.55)");
      cg.addColorStop(0.25, "rgba(255,226,154,.28)");
      cg.addColorStop(0.60, "rgba(255,166,221,.95)");
      cg.addColorStop(1, "rgba(255,121,201,.65)");
      ctx.fillStyle = cg;
      ctx.beginPath();
      ctx.arc(b.x + wind*8, b.y, b.r, 0, Math.PI*2);
      ctx.fill();

      // outline
      ctx.strokeStyle = "rgba(42,23,48,.75)";
      ctx.lineWidth = 5;
      ctx.stroke();
    });

    ctx.restore();
  }

  // Birds (simple but smooth + flapping)
  function drawBird(b){
    const flap = Math.sin(b.wing)*0.9;
    const wingSpan = b.size * (0.9 + 0.25*Math.abs(flap));
    ctx.save();
    ctx.translate(b.x, b.y);
    ctx.scale(b.vx>0 ? 1 : -1, 1);
    ctx.globalAlpha = 0.95;
    ctx.strokeStyle = b.col;
    ctx.lineWidth = 2.2;

    // body arc
    ctx.beginPath();
    ctx.arc(0,0, b.size*0.20, Math.PI*0.2, Math.PI*1.8);
    ctx.stroke();

    // wings
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.quadraticCurveTo( wingSpan*0.55, -b.size*(0.40+0.35*flap), wingSpan, 0);
    ctx.moveTo(0,0);
    ctx.quadraticCurveTo(-wingSpan*0.55, -b.size*(0.40+0.35*flap), -wingSpan, 0);
    ctx.stroke();

    ctx.restore();
  }

  // Butterflies (cute, near ground)
  function drawButterfly(x,y,s,phase){
    const flap = Math.sin(phase)*0.9;
    ctx.save();
    ctx.translate(x,y);
    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = "rgba(42,23,48,.55)";
    ctx.lineWidth = 1.6;

    // glow
    ctx.shadowColor = "rgba(255,121,201,.65)";
    ctx.shadowBlur = 14;

    // wings
    ctx.fillStyle = "rgba(255,121,201,.50)";
    ctx.beginPath();
    ctx.ellipse(-s*0.6, 0, s*(0.55+0.25*Math.abs(flap)), s*(0.40+0.20*Math.abs(flap)), -0.15, 0, Math.PI*2);
    ctx.ellipse( s*0.6, 0, s*(0.55+0.25*Math.abs(flap)), s*(0.40+0.20*Math.abs(flap)),  0.15, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // body
    ctx.shadowBlur = 0;
    ctx.strokeStyle = "rgba(15,15,20,.55)";
    ctx.beginPath();
    ctx.moveTo(0, -s*0.4);
    ctx.lineTo(0, s*0.4);
    ctx.stroke();

    ctx.restore();
  }

  // Hearts + stars
  function drawHeart(x,y,size,color,alpha=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(size/20, size/20);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(0, 6);
    ctx.bezierCurveTo(10, -2, 8, -16, 0, -10);
    ctx.bezierCurveTo(-8, -16, -10, -2, 0, 6);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
  function drawStar(x,y,size,color,alpha=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = color;
    ctx.beginPath();
    const spikes = 5, outer = size, inner = size*0.45;
    let rot = Math.PI / 2 * 3;
    ctx.moveTo(0, -outer);
    for(let i=0;i<spikes;i++){
      ctx.lineTo(Math.cos(rot)*outer, Math.sin(rot)*outer);
      rot += Math.PI/spikes;
      ctx.lineTo(Math.cos(rot)*inner, Math.sin(rot)*inner);
      rot += Math.PI/spikes;
    }
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // Chair + Girl (more shading)
  function drawChair(x,y){
    ctx.save();
    ctx.translate(x,y);
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 5;

    // seat gradient
    let g = ctx.createLinearGradient(-70,0,70,0);
    g.addColorStop(0,"#9c91ff"); g.addColorStop(1,"#c7bcff");
    ctx.fillStyle = g;
    roundRect(-70, 10, 140, 26, 12); ctx.fill(); ctx.stroke();

    // back
    g = ctx.createLinearGradient(-70,-90,70,30);
    g.addColorStop(0,"#a59aff"); g.addColorStop(1,"#d3caff");
    ctx.fillStyle = g;
    roundRect(-70, -95, 140, 110, 16); ctx.fill(); ctx.stroke();

    // legs
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(-55, 36); ctx.lineTo(-55, 96);
    ctx.moveTo( 55, 36); ctx.lineTo( 55, 96);
    ctx.moveTo(-55, 36); ctx.lineTo(-68, 96);
    ctx.moveTo( 55, 36); ctx.lineTo( 68, 96);
    ctx.stroke();

    ctx.restore();
  }

  function drawGirl(x,y,breath,look){
    ctx.save();
    ctx.translate(x, y + breath);

    // head (skin gradient)
    const skin = ctx.createRadialGradient(-18, -140, 10, 0, -120, 70);
    skin.addColorStop(0, "rgba(255,255,255,.85)");
    skin.addColorStop(0.25, "rgba(255,226,154,.28)");
    skin.addColorStop(1, "#ffd7cf");

    // hair gradient
    const hair = ctx.createLinearGradient(-70,-200,70,-80);
    hair.addColorStop(0, "#20121f");
    hair.addColorStop(1, "#3a2440");

    // glow behind head
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "#ff79c9";
    ctx.filter = "blur(18px)";
    ctx.beginPath(); ctx.arc(0, -118, 66, 0, Math.PI*2); ctx.fill();
    ctx.filter = "none"; ctx.globalAlpha = 1;

    // head
    ctx.fillStyle = skin;
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 5;
    ctx.beginPath(); ctx.arc(0, -118, 58, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // hair cap
    ctx.fillStyle = hair;
    ctx.beginPath();
    ctx.arc(0, -130, 60, Math.PI*0.06, Math.PI*0.94, true);
    ctx.closePath(); ctx.fill(); ctx.stroke();

    // bangs
    ctx.fillStyle = hair;
    ctx.beginPath();
    ctx.ellipse(-20, -122, 22, 18, 0.25, 0, Math.PI*2);
    ctx.ellipse( 20, -122, 22, 18,-0.25, 0, Math.PI*2);
    ctx.fill();

    // eyes (with look offset)
    const lx = look*5;
    ctx.fillStyle = "#101018";
    ctx.beginPath(); ctx.arc(-20+lx, -116, 7, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( 20+lx, -116, 7, 0, Math.PI*2); ctx.fill();

    // eye shine
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.beginPath(); ctx.arc(-17+lx, -119, 2.4, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( 23+lx, -119, 2.4, 0, Math.PI*2); ctx.fill();

    // blush
    ctx.fillStyle = "rgba(255,121,201,.32)";
    ctx.beginPath(); ctx.arc(-38, -98, 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( 38, -98, 10, 0, Math.PI*2); ctx.fill();

    // dress (more ‚Äúrealistic‚Äù shading)
    const dress = ctx.createLinearGradient(-50,-70,50,60);
    dress.addColorStop(0, "#5fbfff");
    dress.addColorStop(1, "#a7e7ff");
    ctx.fillStyle = dress;
    roundRect(-35, -64, 70, 74, 22); ctx.fill(); ctx.stroke();

    // small bow
    drawHeart(-10, -46, 10, "rgba(255,226,154,.85)", 1);
    drawHeart( 10, -46, 10, "rgba(255,226,154,.85)", 1);

    // skirt
    ctx.beginPath();
    ctx.moveTo(-48, 10); ctx.lineTo(48, 10); ctx.lineTo(0, 58); ctx.closePath();
    ctx.fill(); ctx.stroke();

    // arms
    ctx.lineWidth = 8;
    ctx.strokeStyle = "rgba(255,215,207,.95)";
    ctx.beginPath();
    ctx.moveTo(-32, -30); ctx.quadraticCurveTo(-76, -10, -58, 18);
    ctx.moveTo( 32, -30); ctx.quadraticCurveTo( 76, -10,  58, 18);
    ctx.stroke();

    // legs (sitting)
    ctx.lineWidth = 10;
    ctx.strokeStyle = "rgba(255,255,255,.95)";
    ctx.beginPath();
    ctx.moveTo(-12, 36); ctx.quadraticCurveTo(-22, 62, -12, 86);
    ctx.moveTo( 12, 36); ctx.quadraticCurveTo( 22, 62,  12, 86);
    ctx.stroke();

    // shoes
    ctx.fillStyle = "#ff79c9";
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 4;
    roundRect(-28, 78, 28, 16, 10); ctx.fill(); ctx.stroke();
    roundRect(0,   78, 28, 16, 10); ctx.fill(); ctx.stroke();

    ctx.restore();
  }

  function drawCat(x,y,wiggle){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(wiggle*0.05);

    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 4;

    ctx.beginPath(); ctx.arc(0, 0, 24, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(24, -8, 20, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    ctx.fillStyle = "#ffa6dd";
    ctx.beginPath(); ctx.moveTo(18, -30); ctx.lineTo(28, -18); ctx.lineTo(8, -18); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(36, -30); ctx.lineTo(44, -18); ctx.lineTo(26, -18); ctx.closePath(); ctx.fill(); ctx.stroke();

    ctx.fillStyle = "#101018";
    ctx.beginPath(); ctx.arc(18, -8, 3.2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(30, -8, 3.2, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // Gift object
  function drawGift(x,y,open01){
    ctx.save();
    ctx.translate(x,y);

    // box glow
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#ff79c9";
    ctx.filter = "blur(18px)";
    roundRect(-80, -26, 160, 124, 20); ctx.fill();
    ctx.filter = "none";
    ctx.globalAlpha = 1;

    ctx.fillStyle = "#ff79c9";
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 5;
    roundRect(-80, -26, 160, 124, 20); ctx.fill(); ctx.stroke();

    ctx.fillStyle = "#ffe29a";
    roundRect(-12, -26, 24, 124, 12); ctx.fill(); ctx.stroke();
    roundRect(-80, 18, 160, 18, 12); ctx.fill(); ctx.stroke();

    // lid
    const lidRot = -1.2 * open01;
    ctx.save();
    ctx.translate(0, -40);
    ctx.rotate(lidRot);
    ctx.translate(0, -10);
    ctx.fillStyle = "#ff79c9";
    roundRect(-86, -20, 172, 40, 16); ctx.fill(); ctx.stroke();
    ctx.fillStyle = "#ffe29a";
    roundRect(-12, -20, 24, 40, 12); ctx.fill(); ctx.stroke();
    ctx.restore();

    // bow
    drawHeart(-18, -58 - open01*10, 18, "#ffe29a", 1);
    drawHeart( 18, -58 - open01*10, 18, "#ffe29a", 1);

    ctx.restore();
  }

  // Wish card
  function drawWishCard(alpha){
    const cx = W/2, cy = H*0.42;
    const w = Math.min(W*0.80, 820);
    const h = Math.min(H*0.40, 300);

    ctx.save();
    ctx.globalAlpha = alpha;

    // glow
    ctx.globalAlpha = alpha*0.35;
    ctx.fillStyle = "#ff79c9";
    ctx.filter = "blur(24px)";
    roundRect(cx-w/2, cy-h/2, w, h, 26); ctx.fill();
    ctx.filter = "none";
    ctx.globalAlpha = alpha;

    // card
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.strokeStyle = "rgba(42,23,48,.85)";
    ctx.lineWidth = 6;
    roundRect(cx-w/2, cy-h/2, w, h, 26);
    ctx.fill(); ctx.stroke();

    // border
    ctx.strokeStyle = "rgba(255,121,201,.85)";
    ctx.lineWidth = 6;
    roundRect(cx-w/2+10, cy-h/2+10, w-20, h-20, 22);
    ctx.stroke();

    // text
    ctx.textAlign = "center";
    ctx.fillStyle = "#2a1730";
    ctx.font = "900 42px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(`Happy Birthday ${BIRTHDAY_NAME}!`, cx, cy-44);

    ctx.font = "700 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "#5b3a6e";
    ctx.fillText("A calm heart, a bright smile, a beautiful year ‚ú®", cx, cy+2);

    ctx.fillStyle = "#6a5aa8";
    ctx.fillText("You deserve the sweetest surprises üéÄ", cx, cy+38);

    ctx.restore();
  }

  // ============================
  // Scene Draws
  // ============================
  function drawBaseNature(dayMood, wind){
    drawSky(dayMood);

    // clouds back
    cloudsBack.forEach(c=> drawCloud(c.x, c.y, c.s, 0.88));
    drawHills(dayMood);
    drawGround();

    // trees (more)
    const baseY = H*0.62;
    drawSakuraTree(W*0.12, baseY-40, 0.92, wind);
    drawSakuraTree(W*0.88, baseY-32, 1.06, -wind*0.6);
    drawSakuraTree(W*0.72, baseY-24, 0.74, wind*0.8);

    // clouds front
    cloudsFront.forEach(c=> drawCloud(c.x, c.y, c.s, 0.92));
  }

  function updateNature(dt, speed){
    // clouds
    cloudsBack.forEach(c=>{
      c.x += c.v*dt*speed*0.75;
      if(c.x > W+320) c.x = -320;
      if(c.x < -320) c.x = W+320;
    });
    cloudsFront.forEach(c=>{
      c.x += c.v*dt*speed;
      if(c.x > W+320) c.x = -320;
      if(c.x < -320) c.x = W+320;
    });

    // birds
    birds.forEach(b=>{
      b.wing += dt*speed*8.5*(0.6 + (1-b.depth));
      b.x += b.vx*dt*speed*(0.65 + (1-b.depth));
      // slight float
      b.y += Math.sin(globalT*0.7 + b.depth*5)*dt*speed*8*(0.6);
      if(b.x > W+220) b.x = -220;
      if(b.x < -220) b.x = W+220;
    });

    // petals
    petals.forEach(p=>{
      p.x += (p.vx + Math.sin(globalT*0.7 + p.y*0.01)*12)*dt*speed;
      p.y += p.vy*dt*speed;
      p.r += p.vr*dt*speed;
      if(p.y > H+30){ p.y = -rand(20, H*0.65); p.x = rand(-160, W+160); }
      if(p.x > W+200) p.x = -200;
      if(p.x < -200) p.x = W+200;
    });

    // leaves
    leaves.forEach(l=>{
      l.x += (l.vx + Math.sin(globalT*1.2 + l.y*0.01)*18)*dt*speed;
      l.y += (l.vy + Math.cos(globalT*0.9 + l.x*0.01)*10)*dt*speed;
      l.r += l.vr*dt*speed;
      if(l.y > H+60){ l.y = -rand(30, H*0.4); l.x = rand(-200, W+200); }
      if(l.x > W+240) l.x = -240;
    });

    // butterflies
    butterflies.forEach(b=>{
      b.ph += dt*speed*7.0;
      b.x += (b.vx + Math.sin(globalT*1.5 + b.ph)*12)*dt*speed;
      b.y += (b.vy + Math.cos(globalT*1.4 + b.ph)*10)*dt*speed;
      // keep near girl area
      const minX=W*0.14, maxX=W*0.58, minY=H*0.34, maxY=H*0.70;
      if(b.x<minX) b.x=minX; if(b.x>maxX) b.x=maxX;
      if(b.y<minY) b.y=minY; if(b.y>maxY) b.y=maxY;
    });
  }

  function drawParticles(wind, dayMood, strength=1){
    // petals (soft hearts)
    petals.forEach(p=>{
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r + wind*0.08);
      ctx.globalAlpha = p.a*strength;
      // glow
      ctx.shadowColor = "rgba(255,121,201,.45)";
      ctx.shadowBlur = 12;
      drawHeart(0,0,p.s, "rgba(255,166,221,.95)", p.a*strength);
      ctx.restore();
    });

    // leaves
    leaves.forEach(l=>{
      ctx.save();
      ctx.translate(l.x, l.y);
      ctx.rotate(l.r);
      ctx.globalAlpha = 0.35*strength;
      ctx.shadowColor = "rgba(140,255,200,.35)";
      ctx.shadowBlur = 10;
      ctx.fillStyle = l.col;
      ctx.beginPath();
      ctx.ellipse(0,0, l.s*0.9, l.s*0.5, 0.4, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    });
  }

  function drawBirdsLayer(){
    // draw sorted by depth (far first)
    const sorted = birds.slice().sort((a,b)=>a.depth-b.depth);
    sorted.forEach(b=> drawBird(b));
  }

  function drawGarden(local, alpha, wind){
    // show popup only in garden
    if(local > 2 && local < 10) showPopup(); else hidePopup();

    drawBaseNature(0.0, wind);

    // birds
    drawBirdsLayer();

    // particles
    drawParticles(wind, 0.0, 1);

    // foreground: chair + girl + cat
    const chairX = W*0.30, chairY = H*0.62 + 58;
    drawChair(chairX, chairY);

    const breath = Math.sin(globalT*2.2)*3.8;
    const look = Math.sin(globalT*0.9)*0.7;
    drawGirl(chairX, chairY, breath, look);
    drawCat(W*0.45, H*0.62 + 86, Math.sin(globalT*2.6));

    // butterflies near girl
    butterflies.forEach(b=> drawButterfly(b.x, b.y, b.s, b.ph));

    // scene caption glow
    softGlowCircle(chairX+80, chairY-220, 18, "rgba(255,226,154,.85)", 18, 0.10);
  }

  function drawGiftScene(local, alpha, wind){
    hidePopup();
    drawBaseNature(0.1, wind);

    drawBirdsLayer();
    drawParticles(wind, 0.1, 0.85);

    // chair + girl (still present)
    const chairX = W*0.28, chairY = H*0.62 + 58;
    drawChair(chairX, chairY);
    drawGirl(chairX, chairY, Math.sin(globalT*2.2)*3.5, Math.sin(globalT*0.9)*0.6);

    // gift open
    const open01 = clamp01((local-0.4)/1.2);
    drawGift(W*0.66, H*0.62 + 68, open01);

    // confetti update + draw
    confetti.forEach(c=>{
      c.life -= dtNow;
      c.vy += c.g*dtNow;
      c.x += c.vx*dtNow;
      c.y += c.vy*dtNow;
      c.r += c.vr*dtNow;

      const a = clamp01(c.life/2.6);
      ctx.save();
      ctx.translate(c.x,c.y);
      ctx.rotate(c.r);
      ctx.globalAlpha = a;
      ctx.shadowColor = c.col;
      ctx.shadowBlur = 14;
      if(c.kind==="heart") drawHeart(0,0,c.s,c.col,a);
      else drawStar(0,0,c.s*0.65,c.col,a);
      ctx.restore();
    });
    confetti = confetti.filter(c => c.life > 0 && c.y < H+160);
  }

  function drawFireworksScene(local, alpha, wind){
    // show popup again (finale vibe)
    if(local > 1.5 && local < 8.5) showPopup(); else hidePopup();

    drawBaseNature(0.55, wind);
    drawBirdsLayer();

    // fewer petals; more sky
    drawParticles(wind, 0.55, 0.55);

    // spawn fireworks
    if(Math.random() < 0.10) spawnFirework();

    fireworks.forEach(fw=>{
      fw.parts.forEach(pt=>{
        pt.life -= dtNow;
        pt.vx *= (1 - 0.78*dtNow);
        pt.vy *= (1 - 0.78*dtNow);
        pt.vy += 140*dtNow;
        pt.x += pt.vx*dtNow;
        pt.y += pt.vy*dtNow;

        const a = clamp01(pt.life/1.8);
        ctx.save();
        ctx.globalAlpha = a;
        ctx.shadowColor = fw.col;
        ctx.shadowBlur = 26;
        drawStar(pt.x, pt.y, 12, fw.col, a);
        // extra glow dot
        softGlowCircle(pt.x, pt.y, 6, fw.col, 18, a*0.20);
        ctx.restore();
      });
    });
    fireworks = fireworks
      .map(fw => ({...fw, parts: fw.parts.filter(p=>p.life>0)}))
      .filter(fw=>fw.parts.length>0);
  }

  function drawCardScene(local, alpha, wind){
    hidePopup();
    drawBaseNature(0.15, wind);
    drawBirdsLayer();
    drawParticles(wind, 0.15, 0.60);

    const a = clamp01(local/1.2);
    drawWishCard(a);

    // floating stickers
    cardStickers.forEach(st=>{
      const bob = Math.sin(globalT*1.6 + st.ph)*8;
      ctx.save();
      ctx.globalAlpha = 0.55 + 0.35*(0.5+0.5*Math.sin(globalT*2.2 + st.ph));
      ctx.font = `900 ${st.s}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.shadowColor = "rgba(255,121,201,.55)";
      ctx.shadowBlur = 16;
      ctx.fillText(st.emoji, st.x + Math.cos(globalT*0.9 + st.ph)*6, st.y + bob);
      ctx.restore();
    });
  }

  // wrappers to match timeline.draw signature
  function drawGardenWrap(local, alpha, wind){ drawGarden(local, alpha, wind); }
  function drawGiftWrap(local, alpha, wind){ drawGiftScene(local, alpha, wind); }
  function drawFireworksWrap(local, alpha, wind){ drawFireworksScene(local, alpha, wind); }
  function drawCardWrap(local, alpha, wind){ drawCardScene(local, alpha, wind); }

  // attach correct draw fns
  timeline[0].draw = drawGardenWrap;
  timeline[1].draw = drawGiftWrap;
  timeline[2].draw = drawFireworksWrap;
  timeline[3].draw = drawCardWrap;

  // ============================
  // Playback control
  // ============================
  let started = false;
  let globalT = 0;
  let dtNow = 0;
  let speedIndex = 0;
  let speed = SPEED_PRESETS[speedIndex];

  // pre-burst confetti so scene 2 is rich
  burstConfetti();

  function setUIForScene(i){
    const seg = timeline[i];
    sceneLabel.textContent = `Scene / ${seg.name}`;
    cornerSticker.textContent = seg.sticker;
    hintLine.textContent = seg.hint;
    status.textContent = `Playing‚Ä¶ (${seg.name})`;
  }

  document.getElementById("startBtn").addEventListener("click", ()=>{
    started = true;
    status.textContent = "Playing‚Ä¶";
  });

  document.getElementById("replayBtn").addEventListener("click", ()=>{
    started = true;
    globalT = 0;
    fireworks = [];
    burstConfetti();
    status.textContent = "Replaying‚Ä¶";
  });

  const speedBtn = document.getElementById("speedBtn");
  speedBtn.textContent = `Speed: ${speed.toFixed(2)}√ó`;
  speedBtn.addEventListener("click", ()=>{
    speedIndex = (speedIndex + 1) % SPEED_PRESETS.length;
    speed = SPEED_PRESETS[speedIndex];
    speedBtn.textContent = `Speed: ${speed.toFixed(2)}√ó`;
  });

  // ============================
  // Main loop
  // ============================
  let last = performance.now();
  function frame(now){
    const rawDt = Math.min(0.033, (now-last)/1000);
    last = now;

    dtNow = rawDt;
    if(started) globalT += rawDt * speed;

    // Update moving nature every frame (even before start, tiny motion)
    const simSpeed = started ? speed : 0.35;
    updateNature(rawDt, simSpeed);

    // Which scene now?
    const s = sceneAtTime(globalT);
    setUIForScene(s.i);

    // Scene alpha (fade)
    const a = fadeAlpha(s.local, s.seg.dur);

    // Wind changes slowly
    const wind = Math.sin(globalT*0.35) * 0.8;

    // Draw current scene
    ctx.clearRect(0,0,W,H);
    s.seg.draw(s.local, a, wind);

    // Extra cinematic grade
    vignette(0.33);

    // Ensure gift confetti refresh at scene start
    if(s.i === 1 && s.local < 0.18 && confetti.length < 80){
      burstConfetti();
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

})();
</script>
</body>
</html>
